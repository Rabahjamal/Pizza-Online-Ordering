<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script>
        document.addEventListener('DOMContentLoaded', function() {
            var menu = {{ serialized_menu | safe }};

            // retrive shopping cart items when the user refresh the page
            $.ajax({
                 dataType: 'json',
                 url: "{% url 'get_shopping_cart_items' %}",
                 success: function (response) {
                      //const li = document.createElement('li');
                      //li.innerHTML = name + " " + item_data['size'] + "(" + item_data['price'] + ")";
                      //document.querySelector('#shopping_list').append(li);
                      console.log(JSON.parse(response));
                      shopping_cart_items = JSON.parse(response);
                      for(var i = 0; i < shopping_cart_items.length; i++)
                      {
                        const li = document.createElement('li');
                        li.innerHTML = shopping_cart_items[i]["name"] + " " +
                         shopping_cart_items[i]['size'] + "(" + shopping_cart_items[i]['price'] + ")";
                        document.querySelector('#shopping_list').append(li);

                        if(shopping_cart_items[i]['toppings'].length)
                        {
                          li.innerHTML += " Toppings: "
                          for(var j = 0; j < shopping_cart_items[i]['toppings'].length - 1; j++)
                          {
                            li.innerHTML += shopping_cart_items[i]['toppings'][j] + ', ';
                          }
                          li.innerHTML += shopping_cart_items[i]['toppings'][shopping_cart_items[i]['toppings'].length - 1];
                        }
                        if(shopping_cart_items[i]['extra'].length)
                        {
                          li.innerHTML += " Extra: "
                          for(var j = 0; j < shopping_cart_items[i]['extra'].length - 1; j++)
                          {
                            li.innerHTML += shopping_cart_items[i]['extra'][j] + ', ';
                          }
                          li.innerHTML += shopping_cart_items[i]['extra'][shopping_cart_items[i]['extra'].length - 1];
                        }
                      }
                 },
                 error: function (response) {
                     // alert the error if any error occured
                     console.log("error");
                 }
               });

            var add_buttons = document.querySelectorAll('.add');
            for(var i = 0; i < add_buttons.length; i++)
            {
                  add_buttons[i].onclick = function()
                  {
                     var button_id = this.id;
                     var id = button_id.split("_")[1];
                     const name = document.querySelector('#itemName_'+id).innerHTML;
                     console.log(name);
                     if(document.querySelector('#small_price_'+id) && document.querySelector('#small_price_'+id).checked)
                     {
                        const small_price = document.querySelector('#small_price_'+id).value;
                        console.log(small_price);
                        //const li = document.createElement('li');
                        //li.innerHTML = name + " Samll(" + small_price + ")";
                        //document.querySelector('#shopping_list').append(li);
                        var item_data = {'item_id': id, 'size': "Small", 'quantity': 1, 'price': small_price, 'toppings': [], 'extra': []};
                     }
                     else if(document.querySelector('#large_price_'+id) && document.querySelector('#large_price_'+id).checked)
                     {
                       const large_price = document.querySelector('#large_price_'+id).value;
                       console.log(large_price);
                       //const li = document.createElement('li');
                       //li.innerHTML = name + " Large(" + large_price + ")";
                       //document.querySelector('#shopping_list').append(li);
                       var item_data = {'item_id': id, 'size': "Large", 'quantity': 1, 'price': large_price, 'toppings': [], 'extra': []};
                     }
                     // check for topping and extra items
                     var toppings = document.querySelectorAll('.Topping_'+id);
                     for(var i = 0; i < toppings.length; i++)
                     {
                       if(toppings[i] && toppings[i].checked)
                       {
                         //console.log(toppings[i].value);
                         item_data["toppings"].push(toppings[i].value);
                       }
                     }

                     var extra = document.querySelectorAll('.Extra_'+id);
                     for(var i = 0; i < extra.length; i++)
                     {
                       if(extra[i] && extra[i].checked)
                       {
                         //console.log(extra[i].value);
                         item_data['extra'].push(extra[i].value)
                       }
                     }
                     console.log(item_data);
                     $.ajaxSetup({
                            headers: { "X-CSRFToken": '{{csrf_token}}' }
                      });
                     $.ajax({
                          type: 'POST',
                          dataType: 'json',
                          contentType: 'application/json; charset=utf-8',
                          url: "{% url 'add_to_shopping_cart' %}",
                          data: JSON.stringify(item_data),
                          success: function (response) {
                               const li = document.createElement('li');
                               li.innerHTML = name + " " + item_data['size'] + "(" + item_data['price'] + ")";
                               if(item_data['toppings'].length)
                               {
                                 li.innerHTML += " Toppings: "
                                 for(var i = 0; i < item_data['toppings'].length - 1; i++)
                                 {
                                   li.innerHTML += item_data['toppings'][i] + ', ';
                                 }
                                 li.innerHTML += item_data['toppings'][item_data['toppings'].length - 1];
                               }
                               if(item_data['extra'].length)
                               {
                                 li.innerHTML += " Extra: "
                                 for(var i = 0; i < item_data['extra'].length - 1; i++)
                                 {
                                   li.innerHTML += item_data['extra'][i] + ', ';
                                 }
                                 li.innerHTML += item_data['extra'][item_data['extra'].length - 1];
                               }
                               document.querySelector('#shopping_list').append(li);
                          },
                          error: function (response) {
                              // alert the error if any error occured
                              console.log("error");
                          }
                        });
                  }
            }
              /*for(var key in menu)
              {
                var category_items = JSON.parse(menu[key]);
                //console.log(category_items);
                for(var item in category_items)
                {
                   console.log('#add_'+category_items[item]["pk"])
                   document.querySelector('#add_'+category_items[item]["pk"]).onclick = function() {
                     const name = document.querySelector('#itemName_'+category_items[item]["pk"]).value;
                     const small_price = document.querySelector('#small_price_'+category_items[item]["pk"]).value;
                     const large_price = document.querySelector('#large_price_'+category_items[item]["pk"]).value;
                     //const name = document.querySelector('#itemName').value;
                   //  const name = document.querySelector('#itemName').value;
                     console.log(name);
                     console.log(small_price);
                     console.log(large_price);
                   };
                }
              }*/
          });
  </script>
</head>
<body>



<h1>Hello, {{ user.first_name }}</h1>
<ul>
    {% for category, items in menu.items %}
      <h3> {{ category }} </h3>
      <ul>
          {% for item in items %}
              <li><a href="" data-toggle="modal" data-target="#{{ item.id }}">{{ item.name }}</a></li>
              <!-- Modal -->
                <div class="modal fade" id="{{ item.id }}" role="dialog">
                  <div class="modal-dialog">

                    <!-- Modal content-->
                <form id="form">
                  {% csrf_token %}
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Modal Header</h4>
                      </div>
                      <div class="modal-body">
                        <p id="itemName_{{ item.id }}">{{ item.name }}</p>
                        {% if item.small_price %}
                          <input type="radio" id="small_price_{{ item.id }}" name="small_price" value="{{ item.small_price}}">
                          <label for="small_price">Small ({{ item.small_price}})</label><br>
                        {% endif %}
                        {% if item.large_price %}
                          <input type="radio" id="large_price_{{ item.id }}" name="large_price" value="{{ item.large_price}}">
                          <label for="large_price">Large ({{ item.large_price}})</label><br>
                        {% endif %}
                      </div>
                      {% if item.number_of_topping %}
                      <p>Toppings</p>
                      {% for topping in toppings %}
                      <input type="checkbox" id="Topping{{topping.id}}_{{ item.id }}" class="Topping_{{item.id}}" name="{{ topping.name }}" value="{{ topping.name }}">
                      <label for="Topping{{topping.id}}">{{ topping.name }}</label><br>
                      {% endfor %}
                      {% endif %}

                      {% if item.number_of_extra_items %}
                      <p>Add extra items to your sub</p>
                      {% for extra_item in extra_items %}
                      <input type="checkbox" id="Extra{{extra_item.id}}_{{ item.id }}" class="Extra_{{item.id}}" name="{{ extra_item.name }}" value="{{ extra_item.name }}">
                      <label for="Extra{{extra_item.id}}">{{ extra_item.name }}</label><br>
                      {% endfor %}
                      {% endif %}
                      <div class="modal-footer">
                        <button id="add_{{ item.id }}" type="button submit" class="btn btn-default add" data-dismiss="modal">Add to cart</button>
                      <!--  <input class="button btn btn-default is-block is-info is-large is-fullwidth" type="submit" data-dismiss="modal" value="Add to cart"> -->
                      </div>
                    </div>
                  </form>
                  </div>
                </div>
          {% endfor %}
      </ul>
    {% endfor %}
</ul>

<div id="shopping_cart">
<h3>Your shopping cart</h3>
<ul id="shopping_list"></ul>
</div>

<a href="{% url 'logout' %}">Logout</a>
</body>
</html>
